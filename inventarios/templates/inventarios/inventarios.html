{% extends "../layouts/base.html" %} {# Estamos cargando la plantilla base#} 
{%load static %} 
{%block title %} Inventarios {% endblock %} 

{% block cabecera_p %} 
  Inventario  
  {% endblock %}

  {% block cabecera_imagen %} 
  <img src="{% static 'img/inventarios.svg' %}" class="img-plantilla" alt="" />
  {% endblock %}
    

{% block content %}

<!-- Modal -->
<div
  class="modal fade {% if editando %}show d-block{% endif %}"
  id="articuloModal"
  tabindex="-1"
  aria-labelledby="articuloModalLabel"
  {%if not editando%} aria-hidden="true"
  {% endif %}
  style="{% if editando %}display:block;{% endif %}"
>

  <div class="modal-dialog">
    <div class="modal-content">
      <form
        method="POST"
        action="{% if editando %}{% url 'editar_articulo' articulo_id %}{% else %}{% url 'crear_articulo' %}{% endif %}"
      >
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="articuloModalLabel">
            {% if editando %}Modificar artículo{% else %}Nuevo artículo{% endif %}
          </h5>
          <a href="{% url 'inventarios' %}" class="btn-close"></a>
        </div>
        <div class="modal-body">{{ form.as_p }}</div>
        <div class="modal-footer">
          <a href="{% url 'inventarios' %}" class="btn btn-secondary">Cancelar</a>
          <button type="submit" class="btn btn-success">
            {% if editando %}Actualizar{% else %}Guardar{% endif %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% if editando %}
<div class="modal-backdrop fade show"></div>
<style>
  body {
    overflow: hidden;
  }
</style>
{% endif %}
  
 {% include 'layouts/submenu_inventario.html' %}

  <button
    class="btn btn-primary mb-3"
    data-bs-toggle="modal"
    data-bs-target="#articuloModal"
  >
    <i class="fas fa-plus-circle"></i> Nuevo artículo  
  </button>
  
  <div class="mb-3" style="max-width: 350px;">
  <label for="buscador-articulos" class="form-label">Buscar artículo</label>
  <select class = "select" id="buscador-articulos" style="width: 100%;"></select>
</div>

<div id="contenedor-tabla">
  {% include 'inventarios/tabla_articulos.html' %}
</div>


  
 <script>

$(document).ready(function () {
    // Inicializar Select2
    $('#buscador-articulos').select2({
        placeholder: 'Seleccione o busque un artículo',
        allowClear: true,
        ajax: {
            url: "{% url 'buscar_articulos_select2' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return { term: params.term || '' };
            },
            processResults: function (data) {
                return { results: data.results };
            }
        }
    });

    // Cuando se selecciona un artículo
    $('#buscador-articulos').on('select2:select', function (e) {
        let articuloId = e.params.data.id;
        let articuloNombre = e.params.data.text;
        actualizarTabla(articuloNombre);
    });

    // Cuando se borra la selección
    $('#buscador-articulos').on('select2:clear', function () {
        actualizarTabla('');
    });

    // Función para actualizar la tabla vía AJAX
    function actualizarTabla(termino) {
        $.ajax({
            url: "{% url 'filtrar_articulo_tabla' %}",
            data: { q: termino },
            success: function (data) {
                $('#contenedor-tabla').html(data);
            }
        });
    }
});
 


</script>
 


  {% endblock %}
</div>
